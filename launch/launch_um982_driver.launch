<?xml version="1.0"?>
<!-- 
  launch_um982_driver.launch
   1. Inyecta RTCM vía NTRIP -> serial (str2str)
   2. Inicia um982_serial_driver.py (lee serial y publica /gngga, /gnrmc, /uniheading)
   3. Inicia um982_topic_driver.py (suscribe a los tópicos y publica /fix, /odom/rmc, /imu/uniheading, /uniheading/heading)
   
-->
<launch>
  <!-- ============================================== -->
  <!-- Parámetros configurables -->
  <!-- ============================================== -->
  
  <!-- Puerto serial -->
  <arg name="serial_port" default="/dev/ttyUSB0" />
  <arg name="serial_port_ntrip" default="ttyUSB0" />
  <arg name="baud" default="115200" />
  
  <!-- Configuración NTRIP -->
  <arg name="ntrip_user" default="vallejosmartinezpj@gmail.com" />
  <arg name="ntrip_host" default="3.143.243.81" />
  <arg name="ntrip_port" default="2101" />
  <arg name="ntrip_mount" default="ManuelBase1" />
  
  <!-- Opciones de lanzamiento -->
  <arg name="enable_ntrip" default="true" />
  <arg name="enable_serial_driver" default="true" />
  <arg name="enable_topic_driver" default="true" />
  
  <!-- Parámetros del topic driver (compatibles con código Python) -->
  <arg name="offset_deg" default="-90.0" />
  <arg name="roll_deg" default="0.0" />
  <arg name="use_only_yaw" default="false" />

  <!-- Offset del sensor GNSS respecto a base_link -->
  <arg name="gps_x" default="0.124372"/>
  <arg name="gps_y" default="-0.270"/>
  <arg name="gps_z" default="0.0"/>
  <arg name="gps_roll"  default="0.0"/>
  <arg name="gps_pitch" default="0.0"/>
  <arg name="gps_yaw"   default="0.0"/>
  
  <!-- Offset del IMU respecto a base_link -->
  <arg name="imu_x" default="0.0"/>
  <arg name="imu_y" default="0.0"/>
  <arg name="imu_z" default="0.0"/>
  <arg name="imu_roll"  default="0.0"/>
  <arg name="imu_pitch" default="0.0"/>
  <arg name="imu_yaw"   default="0.0"/>
  
  <!-- ============================================== -->
  <!-- TRANSFORMADAS ESTÁTICAS -->
  <!-- ============================================== -->
  
  <!-- TF Estática: base_link → gps -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_base_to_gps"
      args="$(arg gps_x) $(arg gps_y) $(arg gps_z) $(arg gps_yaw) $(arg gps_pitch) $(arg gps_roll) base_link gps" />
      
  <!-- TF Estática: base_link → imu_link_2 -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_base_to_imu_2"
      args="$(arg imu_x) $(arg imu_y) $(arg imu_z) $(arg imu_yaw) $(arg imu_pitch) $(arg imu_roll) base_link imu_link_2"/>
    
  <!-- ============================================== -->
  <!-- 1. NTRIP: Inyección de correcciones RTCM -->
  <!-- ============================================== -->
  <group if="$(arg enable_ntrip)">
    <node pkg="um982_driver" type="str2str_ntrip.sh" name="ntrip_rtcm_injector" 
          output="screen" respawn="false">
      <param name="ntrip_url" value="ntrip://$(arg ntrip_user)@$(arg ntrip_host):$(arg ntrip_port)/$(arg ntrip_mount)" />
      <param name="serial_out" value="serial://$(arg serial_port_ntrip):$(arg baud):8:n:1" />
    </node>
  </group>

  <!-- ============================================== -->
  <!-- 2. Serial Driver UM982: Lee puerto serial -->
  <!-- ============================================== -->
  <group if="$(arg enable_serial_driver)">
    <node pkg="um982_driver" type="um982_serial_driver.py" name="um982_serial_driver" 
          output="screen" respawn="true" respawn_delay="2">
      <param name="port" value="$(arg serial_port)" />
      <param name="baud" value="$(arg baud)" />
    </node>
  </group>

  <!-- ============================================== -->
  <!-- 3. Topic Driver UM982: Procesa tópicos NMEA -->
  <!-- ============================================== -->
  <group if="$(arg enable_topic_driver)">
    <node pkg="um982_driver" type="um982_topic_driver.py" name="um982_topic_driver" 
          output="screen" respawn="true" respawn_delay="2">
      <param name="offset_deg" value="$(arg offset_deg)" />
      <param name="roll_deg" value="$(arg roll_deg)" />
      <param name="use_only_yaw" value="$(arg use_only_yaw)" />
    </node>
  </group>

  <!-- ============================================== -->
  <!-- Información de estado -->
  <!-- ============================================== -->
  <node pkg="rostopic" type="rostopic" name="um982_stack_info" 
        args="echo -n 'UM982 Stack Activo: Serial=$(arg enable_serial_driver), Topic=$(arg enable_topic_driver), NTRIP=$(arg enable_ntrip)'" 
        output="screen" launch-prefix="bash -c 'sleep 3; '" />

</launch>
